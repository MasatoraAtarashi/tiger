# Tiger E2E テスト一覧

このディレクトリには、Tigerの動作を検証するためのE2Eテストが含まれています。

## 主な問題

1. **レンダリング問題**: 文字入力のたびに全画面が再描画される（ちらつき）
2. **ツール実行問題**: LLMがツールを呼び出してもファイルが作成されない

## テスト一覧

### 1. `test-runner.js` - 基本的なE2Eテストスイート
```bash
npm run test:e2e
```
**テスト内容:**
- ツール登録の確認
- 重複メッセージの検出
- 入力エコーの問題
- LLMレスポンスの解析
- ツール実行（write_file）

**既知の問題:**
- 非TTY環境で実行されるため、レンダリング問題を検出できない

### 2. `rendering-test.js` - レンダリング問題検出（初版）
```bash
npm run test:rendering
```
**テスト内容:**
- 画面更新頻度の検出
- 重複フレームの検出

**制限:**
- 初期のテスト実装で、問題を正確に検出できない

### 3. `rendering-test-improved.js` - 改善されたレンダリングテスト
```bash
npm run test:rendering2
```
**テスト内容:**
- 初期レンダリングの分析（最初の2秒間）
- 500msウィンドウごとの更新頻度
- エスケープシーケンスの検出
- ツール実行の確認

**改善点:**
- より詳細なフレーム分析
- タイムラインの表示

### 4. `keystroke-rendering-test.js` - キーストロークごとのレンダリングテスト
```bash
npm run test:keystroke
```
**テスト内容:**
- "hello"を1文字ずつ入力
- 各キーストロークでの全画面再描画を検出
- TIGERヘッダーの出現回数をカウント

**重要:** TTYモードでの実行が必要だが、現在は非TTYで実行されるため問題を検出できない

### 5. `simple-rendering-test.js` - シンプルな検出テスト
```bash
npm run test:simple
```
**テスト内容:**
- フレーム数のカウント
- 非TTYモードであることを認識し、手動テストを推奨

**目的:**
- 問題の存在を認識させる
- 手動テストへの誘導

### 6. `manual-test.sh` - 手動テストスクリプト（Bash）
```bash
./test/e2e/manual-test.sh
```
**テスト内容:**
- expectスクリプトを使用したTTYエミュレーション
- 画面クリアシーケンスのカウント

**制限:**
- 環境依存（expect必要）
- ソケット経由では動作しない

### 7. `verify-rendering-issue.md` - 手動検証ドキュメント
レンダリング問題を手動で確認する方法を記載

## テスト実行時の注意点

### レンダリング問題について
- **自動テストの限界**: 非TTY環境では問題を完全に再現できません
- **手動確認が必要**: 実際のターミナルで `npm run dev` を実行し、文字を入力して確認

### 確認方法
1. ターミナルで `node dist/cli.js --no-logo` を実行
2. ゆっくりと文字を入力（h, e, l, l, o）
3. 各文字入力時に画面全体が再描画されるか確認

### 期待される動作
- 入力フィールドのみが更新される
- ヘッダーやボーダーは再描画されない

### 実際の動作（バグ）
- 文字入力ごとに画面全体がクリアされる
- `[2J[3J[H]` エスケープシーケンスが発行される
- ヘッダー "🐯 TIGER CONSOLE v1.0 🐯" が点滅する

## 修正のヒント

### レンダリング問題の修正箇所
1. **ChatApp.tsx**
   - 不要な state 更新を防ぐ
   - コンポーネントの分離を改善

2. **Layout.tsx**
   - 静的コンテンツをメモ化
   - React.memoの適切な使用

3. **InputArea.tsx**
   - 入力フィールドのみの更新に最適化
   - 親コンポーネントへの不要な伝播を防ぐ

4. **Ink設定**
   - `patchConsole: false` の設定
   - レンダリング最適化オプションの調整

### ツール実行問題の修正箇所
1. **tool-parser.ts**
   - 異なるツール呼び出し形式への対応
   - パースエラーのハンドリング

2. **確認ダイアログ**
   - 非インタラクティブモードでのスキップ
   - `TIGER_NO_RENDER` 環境変数のチェック

## デバッグ方法

1. **ログファイルの確認**
   - `test-output.log`
   - `test-detailed.log`
   - `test-keystroke.log`

2. **環境変数**
   - `TIGER_DEBUG=true` でデバッグモード
   - `TIGER_NO_RENDER=true` で非レンダリングモード

3. **直接実行**
   ```bash
   # インタラクティブモード（問題が再現する）
   node dist/cli.js --no-logo
   
   # 非インタラクティブモード（問題が再現しない）
   echo "test" | node dist/cli.js --no-logo
   ```

## 今後の改善案

1. **node-ptyの使用**
   - 真のTTYエミュレーション
   - より正確な問題検出

2. **Playwrightの使用**
   - ターミナルUIのE2Eテスト
   - スクリーンショット比較

3. **パフォーマンステスト**
   - レンダリング時間の測定
   - メモリ使用量の監視